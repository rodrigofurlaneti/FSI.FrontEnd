<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atualizar Comanda</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../../css/command.css">
    <script src="../../routes/route.js"></script>
</head>
<body>
    <div class="container mt-4 text-center">
        <h1>Atualizar Comanda</h1>

        <form id="updateCommandForm">
            <input type="hidden" id="commandId" name="commandId">
  
                <div class="row justify-content-md-center" style="padding-top: 1vh;">
                    <label for="idUser" class="col-sm-2 col-form-label">Usuário</label>
                    <div class="col-sm-4">
                        <select class="form-select form-select-sm" id="idUser" name="idUser" required>
                            <option value="">Carregando usuários...</option>
                        </select>
                    </div>
                </div>
    
                <div class="row justify-content-md-center">
                    <div class="col-sm-2">
                        <a href="command.html" class="btn btn-secondary btn-sm">
                            Voltar
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-return-left iconText" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M14.5 1.5a.5.5 0 0 1 .5.5v4.8a2.5 2.5 0 0 1-2.5 2.5H2.707l3.347 3.346a.5.5 0 0 1-.708.708l-4.2-4.2a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 8.3H12.5A1.5 1.5 0 0 0 14 6.8V2a.5.5 0 0 1 .5-.5" />
                            </svg>
                        </a>
                    </div>
                    <div class="col-sm-2">
                        <button type="submit" class="btn btn-success btn-sm">
                            Salvar
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-down iconText" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M3.5 6a.5.5 0 0 0-.5.5v8a.5.5 0 0 0 .5.5h9a.5.5 0 0 0 .5-.5v-8a.5.5 0 0 0-.5-.5h-2a.5.5 0 0 1 0-1h2A1.5 1.5 0 0 1 14 6.5v8a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 14.5v-8A1.5 1.5 0 0 1 3.5 5h2a.5.5 0 0 1 0 1z" />
                                <path fill-rule="evenodd" d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </form>
    </div>

    <script>
        async function loadUsers() {
            try {
                const response = await fetch(urlBaseApiUser);

                if (!response.ok) {
                    throw new Error(`Erro ao carregar usuários: ${response.status} ${response.statusText}`);
                }

                const users = await response.json();
                const selectUser = document.getElementById("idUser");

                // Limpar opções anteriores
                selectUser.innerHTML = '<option value="">Selecione uma usuário</option>';

                // Preencher o select com as usuários retornadas
                users.forEach(user => {
                    const option = document.createElement("option");
                    option.value = user.id; // Usa o ID do usuário como valor
                    option.textContent = user.username; // Usa o nome do usuário como texto
                    selectUser.appendChild(option);
                });

            } catch (error) {
                console.error("Erro ao buscar as usuários:", error);
                document.getElementById("idUser").innerHTML = '<option value="">Erro ao carregar as usuários</option>';
            }
        }

        // Chama a função ao carregar a página
        document.addEventListener("DOMContentLoaded", loadUsers);
    </script>

    <script>
        const apiUrl = urlBaseApiCommand;
        const usersApiUrl = urlBaseApiUser; // API de Users
        const urlParams = new URLSearchParams(window.location.search);
        const commandId = urlParams.get("id");

        // Função para carregar os usuários dinamicamente
        async function loadUsers() {
            const userSelect = document.getElementById("idUser");

            try {
                const response = await fetch(usersApiUrl);
                if (!response.ok) throw new Error("Erro ao carregar is usuários.");

                const users = await response.json();
                userSelect.innerHTML = `<option value="">Selecione um usuário</option>`;
                
                users.forEach(user => {
                    userSelect.innerHTML += `<option value="${user.id}">${user.username}</option>`;
                });

            } catch (error) {
                userSelect.innerHTML = `<option value="">Erro ao carregar os usuários</option>`;
                console.error(error);
            }
        }

        // Função para carregar os dados do comanda
        async function loadCommandData() {
        if (!commandId) {
            alert("ID do comanda não encontrado!");
            window.location.href = "command.html";
            return;
        }

        try {
            const response = await fetch(`${apiUrl}/${commandId}`);
            if (!response.ok) throw new Error("Erro ao carregar comanda.");

            const command = await response.json();

            document.getElementById("commandId").value = command.id;

            await loadUsers(); // Aguarde o carregamento das usuários antes de definir o valor

            if (command.idUser) {
                document.getElementById("idUser").value = command.idUser;
            }

        } catch (error) {
            alert("Erro ao carregar os dados: " + error.message);
        }
    }

        // Função para atualizar o comanda
        document.getElementById("updateCommandForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            const updatedCommand = {
                id: document.getElementById("commandId").value,
                idUser: parseInt(document.getElementById("idUser").value),
                status: document.getElementById("status").value === "true"
            };

            try {
                const response = await fetch(`${apiUrl}/${commandId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedCommand)
                });

                if (!response.ok) throw new Error("Erro ao atualizar comanda.");

                alert("Comanda atualizado com sucesso!");
                window.location.href = "command.html";
            } catch (error) {
                alert("Erro ao salvar alterações: " + error.message);
            }
        });

        loadCommandData();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
